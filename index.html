<html>
  <head>
    <title>TEST D3</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet"/>

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js" integrity="sha384-6khuMg9gaYr5AxOqhkVIODVIvm9ynTT5J4V1cfthmT+emCG6yVmEZsRHdxlotUnm" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/d3@5.16.0/dist/d3.min.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.min.js"></script>
    <!--<script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>-->
	  <script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
    <!--<script src="js/FileSaver.min.js"></script>-->


    <style>
      body {
        margin: 20px;
      }

      line {
        /*stroke: black;*/
        /*stroke-width: 1px;*/
        fill: none;
      }

      .tooltip {
        font: 12px sans-serif;
      }
    </style>
  </head>

  <body>
    <h2>D3 test</h2>
    <div style="display:flex;margin-bottom:1rem">
      <div style="border:1px solid #CCC;border-radius:4px;padding:4px 10px">
        <div>Ancestry</div>
        <div>
          <input type="checkbox" class="benchmark_ancestry_cb" checked id="grpName_1" value="Euro">
          <label class="mb-0" for="grpName_1"> Euro</label>
        </div>
        <div>
          <input type="checkbox" class="benchmark_ancestry_cb" checked id="grpName_2" value="AA">
          <label class="mb-0" for="grpName_3"> AA</label>
        </div>
        <div>
          <input type="checkbox" class="benchmark_ancestry_cb" checked id="grpName_3" value="SA">
          <label class="mb-0" for="grpName_2"> SA</label>
        </div>
      </div>
    </div>
    <div>
      <div style="border:2px solid #007C82;border-radius:4px;padding:2px;float:left">
        <svg id="pgs_chart"></svg>
      </div>
      <div style="clear:both">
    </div>
    <div class="mt-2" style="display:flex">
      <div class="btn btn-primary btn-sm mr-2" id="exportPDF">Export to PDF</div>
      <div class="btn btn-primary btn-sm" id="exportPNG">Export to PNG</div>
    </div>
    <script type="text/javascript">

      // generate random data with d3 range and map
      /*var data = d3.range(40).map(function(i) {
        return {
          x: i + 1,
          // generate a random value between 40 and 60
          y: d3.randomUniform(40, 60)(),
          // generate a random interval between 1 and 5
          e: d3.randomUniform(1, 5)()
        };
      });*/

      const pgs_data = [
            { pgs: 'PGS000055', grpName:'Euro', y: 0.32104382, eb: 0.293867188, et: 0.348220452 },
            { pgs: 'PGS000055', grpName:'AA', y: 0.184892118, eb: -0.089983334, et: 0.45976757 },
            { pgs: 'PGS000055', grpName:'SA', y: -0.105811523, eb: -0.46257336, et: 0.250950314 },
            { pgs: 'PGS000074', grpName:'Euro', y: 0.296599424, eb: 0.270089896, et: 0.323108952 },
            { pgs: 'PGS000074', grpName:'AA', y: -0.00856871, eb: -0.285986641, et: 0.268849221 },
            { pgs: 'PGS000074', grpName:'SA', y: 0.202909229, eb: -0.15867862, et: 0.564497078 },
            { pgs: 'PGS000146', grpName:'Euro', y: 0.26389975, eb: 0.236905544, et: 0.290893957 },
            { pgs: 'PGS000146', grpName:'AA', y: 0.055109248, eb: -0.221344814, et: 0.331563311 },
            { pgs: 'PGS000146', grpName:'SA', y: -0.04312567, eb: -0.396279707, et: 0.310028367 },
            { pgs: 'PGS000147', grpName:'Euro', y: 0.18110247, eb: 0.15386322, et: 0.20834172 },
            { pgs: 'PGS000147', grpName:'AA', y: 0.094618527, eb: -0.176487732, et: 0.365724786 },
            { pgs: 'PGS000147', grpName:'SA', y: 0.36462254, eb: 0.007658949, et: 0.721586142 },
            { pgs: 'PGS000148', grpName:'Euro', y: 0.276220866, eb: 0.249458753, et: 0.302982979 },
            { pgs: 'PGS000148', grpName:'AA', y: -0.030533223, eb: -0.393065502, et: 0.331999056 },
            { pgs: 'PGS000148', grpName:'SA', y: 0.156825277, eb: -0.120120911, et: 0.433771465 }
      ];

      //var width = document.documentElement.clientWidth,
      //    height = document.documentElement.clientHeight;
      var width = 1000,
          height = 500;

      // SVG space
      var svg = d3.select('svg').attr('width', width).attr('height', height);

      var margin = {top: 20, right: 100, bottom: 60, left: 60},
          chartWidth = width - margin.left - margin.right,
          chartHeight = height - margin.top - margin.bottom;
      var g = svg.append('g').attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');


      // x and y axis definition
      var categoriesNames = [...new Set(pgs_data.map(item => item.pgs))];
      //var groupNames = [...new Set(pgs_data.map(item => item.grpName))];
      var groupNames = [];
      $(".benchmark_ancestry_cb").each(function () {
        if ($(this).prop("checked"))  {
          groupNames.push($(this).val());
        }
      })
      var y_data =  [...new Set(pgs_data.map(item => item.y))];

      // The scale spacing the groups:
      var x0 = d3.scaleBand()
          .domain(categoriesNames)
          .rangeRound([0, chartWidth])
          .paddingInner(0.05);

      // The scale for spacing each group's bar:
      var x1 = d3.scaleBand()
          //.padding(0.05);
          .domain(groupNames)
          .padding(1);

      var y = d3.scaleLinear()
          .rangeRound([chartHeight, 0]);

      var z = d3.scaleOrdinal()
          .domain(groupNames)
          .range(["#367DB7", "#4CAE49", "#974DA2"]);

      // Define the div for the tooltip
      var div = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);

      console.log(categoriesNames);
      console.log(groupNames);

      var min_value = d3.min(pgs_data, function(d) { return (d.eb); });
      if (min_value > 0) {
        min_value = 0
      }
      else {
        min_value = min_value + ((min_value/100)*10);
      }
      var max_value = d3.max(pgs_data, function(d) { return (d.et); });
      max_value = max_value + ((max_value/100)*10);

      x0.domain(categoriesNames);
      x1.domain(groupNames).rangeRound([0, x0.bandwidth()]);
      y.domain([min_value, max_value]);


      // Draw data on the chart
      var addData = function() {

        selected_data = [];
        for (var i=0;i<pgs_data.length;i++) {
          if (groupNames.indexOf(pgs_data[i].grpName) != -1) {
            selected_data.push(pgs_data[i]);
          }
        }

        var chart_content = g.append("g").attr('class', 'chart_content');

        /* Lines */

        var lines = chart_content.selectAll('line.error')
          .data(selected_data);
          //.data(pgs_data);

        // Vertical line
        lines.enter().append('line')
          .attr('class', 'error')
          .attr('class', function(d) { return 'error '+d.grpName })
          .attr("stroke", function(d) { return z(d.grpName); })
          .attr("stroke-width", 2)
          //.each(function(d,i){
          //  addTooltip($(this), d);
          //})
        //.merge(lines)
          .attr('x1', function(d) { return x1(d.grpName); })
          .attr('x2', function(d) { return x1(d.grpName); })
          .attr('y1', function(d) { return y(d.et); })
          .attr('y2', function(d) { return y(d.eb); });
        // Horizontal line - top
        lines.enter().append('line')
          .attr('class', function(d) { return 'error '+d.grpName })
          .attr("stroke", function(d) { return z(d.grpName); })
          .attr("stroke-width", 2)
          //.each(function(d,i){
          //  addTooltip($(this), d);
          //})
        //.merge(lines)
          .attr('x1', function(d) { return x1(d.grpName)-5; })
          .attr('x2', function(d) { return x1(d.grpName)+5; })
          .attr('y1', function(d) { return y(d.et); })
          .attr('y2', function(d) { return y(d.et); });
        // Horizontal line - bottom
        lines.enter().append('line')
          .attr('class', function(d) { return 'error '+d.grpName })
          .attr("stroke", function(d) { return z(d.grpName); })
          .attr("stroke-width", 2)
          //.each(function(d,i){
          //  addTooltip($(this), d);
          //})
        //.merge(lines)
          .attr('x1', function(d) { return x1(d.grpName)-5; })
          .attr('x2', function(d) { return x1(d.grpName)+5; })
          .attr('y1', function(d) { return y(d.eb); })
          .attr('y2', function(d) { return y(d.eb); });

        chart_content.selectAll('line.error')
          //.transition()
          .attr("transform",function(d) { return "translate(" + x0(d.pgs) + ",0)"; });


        /* Points */

        var points = chart_content.selectAll('circle.point')
          .data(selected_data);
            //.data(pgs_data);

        points.enter()
          .append('circle')
          .attr('class', function(d) { return 'point '+d.grpName })
          .attr("transform",function(d) { return "translate(" + x0(d.pgs) + ",0)"; })
          .attr('r', 4)
          .attr("fill", function(d) { return z(d.grpName); })
          //.each(function(d,i){
          //  addTooltip($(this), d);
          //})
          .attr('cx', function(d) { return x1(d.grpName); })
          .attr('cy', function(d) { return y(d.y); });



        /* Rectangle area used by tooltip */
        chart_content.selectAll('rect')
          .data(selected_data)
          .enter()
          .append('rect')
          .attr('class', function(d) { return 'rect '+d.grpName })
          .attr("transform",function(d) { return "translate(" + x0(d.pgs) + ",0)"; })
          .each(function(d,i){
            addTooltip($(this), d);
          })
          .attr("x", function(d) { return x1(d.grpName) - 6; })
          .attr("y", function(d) { return y(d.et) - 1; })
          .attr("width", 12)
          .attr("height", function(d) { return y(d.eb) - y(d.et) + 2; })
          .attr("fill", "transparent");
      }


      // Draw legend on the chart
      var addLegend = function() {

        var legend = g.append("g")
          .attr("font-family", "sans-serif")
          .attr("font-size", 10)
          .attr("text-anchor", "end")
          .attr("class", "chart_legend")
          .selectAll("g")
          .data(groupNames.slice())
          .enter().append("g")
          .attr("class", function(d) { return d; } )
          .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
        legend.append("circle")
          .attr("r", 4)
          .attr("cx", chartWidth + 20)
          .attr("cy", 9.5)
          .attr("fill", z);
        legend.append("line")
          .attr("x1", chartWidth + 10)
          .attr("x2", chartWidth + 30)
          .attr("y1", 9.5)
          .attr("y2", 9.5)
          .attr("stroke", z)
          .attr("stroke-width", 2);
        legend.append("text")
          .attr("x", chartWidth + 40)
          .attr("y", 9.5)
          .attr("dy", "0.32em")
          .attr("text-anchor", "start")
          .text(function(d) { return d; });
      }


      // Add tooltip on the chart elements
      var addTooltip = function(elem, data) {
        elem.tooltip({
          'title': "Ancestry: <b>"+data.grpName + "</b><br/>Upper 95: <b>" + data.et + "</b><br/>Estimate: <b>" + data.y + "</b><br/>Lower 95: <b>" + data.eb+"</b>",
          'placement': 'right',
          'html': true
        });
      }


      // This function is gonna change the opacity and size of selected and unselected circles
      function update_ancestry(){

        groupNames = [];
        $(".benchmark_ancestry_cb").each(function () {
          if ($(this).prop("checked"))  {
            groupNames.push($(this).val());
          }
        })

        // Remove chart content
        svg.selectAll('.chart_content').remove();
        svg.selectAll('.chart_legend').remove();

        x1.domain(groupNames).rangeRound([0, x0.bandwidth()]);
        // Load updated set of data to the chart
        addData();
        // Load updated legend on the chart
        addLegend();

        /*d3.selectAll(".benchmark_ancestry_cb").each(function(d){
          cb = d3.select(this);
          grp = cb.property("value");

          // If the box is check, I show the group
          if(cb.property("checked")){
            //console.log(grp+": checked");
            checked_gp_names.push(grp);
            svg.selectAll("."+grp).transition().duration(200).style("opacity", 1);
            svg.selectAll("."+grp).style("display", 'block');
          // Otherwise I hide it
          } else{
            svg.selectAll("."+grp).transition().duration(200).style("opacity", 0);
            svg.selectAll("."+grp).style("display", 'none');
          }

        });
        //x1.domain(checked_gp_names);
        x1.domain(checked_gp_names).rangeRound([0, x0.bandwidth()]);*/
      }


      /* Drawing/updating chart */

      // Axes
      var xAxis = g.append('g')
        .attr('transform', 'translate(0,' + chartHeight + ')')
        .call( d3.axisBottom(x0) );
      var yAxis = g.append('g')
        .call( d3.axisLeft(y) );


      // X axis label
      svg.append("text")
        .attr("transform", "translate(" + (chartWidth/2) + " ," + (height - 20) + ")")
        .style("text-anchor", "middle")
        .text("PGS Catalog Score ID");

      // Y axis label
      svg.append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 10)
          .attr("x", 0 - (height / 2))
          //.attr("y", 0 - margin.left)
          //.attr("x",0 - (height / 2))
          .attr("dy", "1em")
          .style("text-anchor", "middle")
          .text("Hazard Ratio (HR)");


      // Threshold/horizontal line
      if (min_value < 0) {
        g.append("line")
          .attr("stroke", 'black')
          .attr("stroke-width", 1)
          .style("stroke-dasharray", ("6, 6"))
          .attr('x1', 0)
          .attr('x2', chartWidth)
          .attr('y1', y(0))
          .attr('y2', y(0));
      }

      // Load data in the chart
      addData();

      // Load legend in the chart
      addLegend();

      // When a button change, I run the update function
      d3.selectAll(".benchmark_ancestry_cb").on("change",update_ancestry);



      $("#exportPDF").click(() => {
        let svg = new XMLSerializer().serializeToString(document.getElementById("pgs_chart"));
        let canvas = document.createElement("canvas");
        let svgSize = $(svg)[0];
        // let svgSize = $(svg)[0].getBoundingClientRect();
        canvas.width = svgSize.width.baseVal.value;
        canvas.height = svgSize.height.baseVal.value;

        let ctx = canvas.getContext("2d");
        let doc = new jsPDF({
          orientation: 'l',
          unit: 'px'
        });
        let img = document.createElement("img");
        img.onload = () => {
          ctx.drawImage(img, 0, 0);
          doc.setFontSize(12);
          doc.text(5, 10, 'PGS Chart');
          doc.addImage(canvas.toDataURL("image/png"), 'PNG', 10, 10);
          doc.save('pgs_benchmark.pdf');
        };
        img.setAttribute("src", "data:image/svg+xml;base64," + btoa(svg));
      });


      $("#exportPNG").on("click", function() {
        var svgString = getSVGString(svg.node());
      	svgString2Image( svgString, 2*width, 2*height, 'png');//, save ); // passes Blob and filesize String to the callback

      	/*function save( dataBlob, filesize ){
      		saveAs( dataBlob, 'PGS_benchmark.png' ); // FileSaver.js function
      	}*/
      });


      // Below are the functions that handle actual exporting:
      function getSVGString( svgNode ) {
      	svgNode.setAttribute('xlink', 'http://www.w3.org/1999/xlink');
      	var cssStyleText = getCSSStyles( svgNode );
      	appendCSS( cssStyleText, svgNode );

      	var serializer = new XMLSerializer();
      	var svgString = serializer.serializeToString(svgNode);
      	svgString = svgString.replace(/(\w+)?:?xlink=/g, 'xmlns:xlink='); // Fix root xlink without namespace
      	svgString = svgString.replace(/NS\d+:href/g, 'xlink:href'); // Safari NS namespace fix

      	return svgString;

        // Extract CSS styling
      	function getCSSStyles( parentElement ) {
      		var selectorTextArr = [];

      		// Add Parent element Id and Classes to the list
      		selectorTextArr.push( '#'+parentElement.id );
      		for (var c = 0; c < parentElement.classList.length; c++) {
      			if ( !contains('.'+parentElement.classList[c], selectorTextArr) ) {
      				selectorTextArr.push( '.'+parentElement.classList[c] );
            }
          }

      		// Add Children element Ids and Classes to the list
      		var nodes = parentElement.getElementsByTagName("*");
      		for (var i = 0; i < nodes.length; i++) {
      			var id = nodes[i].id;
      			if ( !contains('#'+id, selectorTextArr) ) {
      				selectorTextArr.push( '#'+id );
            }

      			var classes = nodes[i].classList;
      			for (var c = 0; c < classes.length; c++)
      				if ( !contains('.'+classes[c], selectorTextArr) ) {
      					selectorTextArr.push( '.'+classes[c] );
              }
      		}

      		// Extract CSS Rules
      		var extractedCSSText = "";
      		for (var i = 0; i < document.styleSheets.length; i++) {
      			var s = document.styleSheets[i];
      			try {
      			  if(!s.cssRules) continue;
      			} catch( e ) {
      		    if(e.name !== 'SecurityError') throw e; // for Firefox
      		    continue;
      		  }

      			var cssRules = s.cssRules;
      			for (var r = 0; r < cssRules.length; r++) {
      				if ( contains( cssRules[r].selectorText, selectorTextArr ) ) {
      					extractedCSSText += cssRules[r].cssText;
              }
      			}
      		}

      		return extractedCSSText;

      		function contains(str,arr) {
      			return arr.indexOf( str ) === -1 ? false : true;
      		}
      	}

      	function appendCSS( cssText, element ) {
      		var styleElement = document.createElement("style");
      		styleElement.setAttribute("type","text/css");
      		styleElement.innerHTML = cssText;
      		var refNode = element.hasChildNodes() ? element.children[0] : null;
      		element.insertBefore( styleElement, refNode );
      	}
      }

      function svgString2Image( svgString, width, height, format) {//, callback ) {
      	var format = format ? format : 'png';

      	var imgsrc = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svgString ) ) ); // Convert SVG string to data URL

      	var canvas = document.createElement("canvas");
      	var context = canvas.getContext("2d");

      	canvas.width = width;
      	canvas.height = height;

      	var image = new Image();
      	image.onload = function() {
      		context.clearRect ( 0, 0, width, height );
      		context.drawImage(image, 0, 0, width, height);

      		canvas.toBlob( function(blob) {
            saveAs( blob, 'PGS_benchmark.png' );
      			//var filesize = Math.round( blob.length/1024 ) + ' KB';
      			//if ( callback ) callback( blob, filesize );
      		});
      	};
      	image.src = imgsrc;
      }

    </script>
  </body>
</html>
