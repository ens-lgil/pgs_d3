<html>
  <head>
    <title>TEST D3</title>
    <script src="d3.min.js"></script>

    <style>
      body {
        margin: 20px;
      }

      line {
        /*stroke: black;*/
        stroke-width: 1px;
        fill: none;
      }
    </style>
  </head>

  <body>
    <h2>D3 test</h2>
    <svg style="border:1px solid #F00"></svg>
    <script type="text/javascript">

      // generate random data with d3 range and map
      var data = d3.range(40).map(function(i) {
        return {
          x: i + 1,
          // generate a random value between 40 and 60
          y: d3.randomUniform(40, 60)(),
          // generate a random interval between 1 and 5
          e: d3.randomUniform(1, 5)()
        };
      });

      const pgs_data = [
            { pgs: 'PGS000055', grpName:'Team1', y: 10, e: d3.randomUniform(1, 5)()},
            { pgs: 'PGS000055', grpName:'Team2', y: 12, e: d3.randomUniform(1, 5)()},
            { pgs: 'PGS000055', grpName:'Team3', y: 14, e: d3.randomUniform(1, 5)()},
            { pgs: 'PGS000074', grpName:'Team1', y: d3.randomUniform(40, 60)(), e: d3.randomUniform(1, 5)()},
            { pgs: 'PGS000074', grpName:'Team2', y: d3.randomUniform(40, 60)(), e: d3.randomUniform(1, 5)()},
            { pgs: 'PGS000074', grpName:'Team3', y: d3.randomUniform(40, 60)(), e: d3.randomUniform(1, 5)()},
            { pgs: 'PGS000146', grpName:'Team1', y: d3.randomUniform(40, 60)(), e: d3.randomUniform(1, 5)()},
            { pgs: 'PGS000146', grpName:'Team2', y: d3.randomUniform(40, 60)(), e: d3.randomUniform(1, 5)()},
            { pgs: 'PGS000146', grpName:'Team3', y: d3.randomUniform(40, 60)(), e: d3.randomUniform(1, 5)()},
            { pgs: 'PGS000147', grpName:'Team1', y: d3.randomUniform(30, 50)(), e: d3.randomUniform(1, 5)()},
            { pgs: 'PGS000147', grpName:'Team2', y: d3.randomUniform(30, 50)(), e: d3.randomUniform(1, 5)()},
            { pgs: 'PGS000147', grpName:'Team3', y: d3.randomUniform(30, 50)(), e: d3.randomUniform(1, 5)()}
      ];

      //var width = document.documentElement.clientWidth,
      //    height = document.documentElement.clientHeight;
      var width = 1000,
          height = 500;

      // SVG space
      var svg = d3.select('svg').attr('width', width).attr('height', height);

      var margin = {top: 20, right: 50, bottom: 30, left: 50};
      var chartWidth = width - margin.left - margin.right;
      var chartHeight = height - margin.top - margin.bottom;
      var g = svg.append('g').attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');


      // x and y axis definition
      var categoriesNames = [...new Set(pgs_data.map(item => item.pgs))];
      var groupNames = [...new Set(pgs_data.map(item => item.grpName))];
      var y_data =  [...new Set(pgs_data.map(item => item.y))];

      // The scale spacing the groups:
      var x0 = d3.scaleBand()
          .rangeRound([0, width-100])
          .paddingInner(0.05);

      // The scale for spacing each group's bar:
      var x1 = d3.scaleBand()
          //.padding(0.05);
          .padding(1);

      var y = d3.scaleLinear()
          .rangeRound([chartHeight, 0]);

      var z = d3.scaleOrdinal()
          .range(["#AA0000", "#00AA00", "#0000AA"]);

      //for (pgs_idx in pgs_data) {
      //  if (!groupNames.includes(grpName)) {

      /*var groupNames = []
      for (gpdata in groupData) {
        for (value in groupData[gpdata].values) {
          grpName = groupData[gpdata].values[value].grpName;
          if (!groupNames.includes(grpName)) {
            groupNames.push(grpName);
          }
        }
      }*/

      console.log(categoriesNames);
      console.log(groupNames);
      x0.domain(categoriesNames);
      x1.domain(groupNames).rangeRound([0, x0.bandwidth()]);
      y.domain([0, d3.max(pgs_data, function(d) { return (d.y+d.e); })]);


      var addData = function() {

        var error_bar = g.append("g");

        var points = error_bar.selectAll('circle.point')
          .data(pgs_data);
          //.attr("transform",function(d) { return "translate(" + x0(d.pgs) + ",0)"; });

        points.enter()
          .append('circle')
          .attr('class', 'point')
          .attr('r', 3)
          .attr("fill", function(d) { return z(d.grpName); })
          //.attr("transform",function(d) { return "translate(" + x0(d.key) + ",0)"; })
        .merge( points )
            .attr('cx', function(d) { return x1(d.grpName); })
            .attr('cy', function(d) { return y(d.y); });

        error_bar.selectAll('circle.point')
              .attr("transform",function(d) { return "translate(" + x0(d.pgs) + ",0)"; });


        var lines = error_bar.selectAll('line.error')
          .data(pgs_data);
          //.attr("transform",function(d) { return "translate(" + x0(d.pgs) + ",0)"; });

        // Vertical line
        lines.enter()
          .append('line')
          .attr('class', 'error')
          .attr("stroke", function(d) { return z(d.grpName); })
        .merge(lines)
          .attr('x1', function(d) { return x1(d.grpName); })
          .attr('x2', function(d) { return x1(d.grpName); })
          .attr('y1', function(d) { return y(d.y + d.e); })
          .attr('y2', function(d) { return y(d.y - d.e); });
        // Horizontal line - top
        lines.enter().append('line')
          .attr('class', 'error')
          .attr("stroke", function(d) { return z(d.grpName); })
        .merge(lines)
          .attr('x1', function(d) { return x1(d.grpName)-5; })
          .attr('x2', function(d) { return x1(d.grpName)+5; })
          .attr('y1', function(d) { return y(d.y + d.e); })
          .attr('y2', function(d) { return y(d.y + d.e); });
        // Horizontal line - bottom
        lines.enter().append('line')
          .attr('class', 'error')
          .attr("stroke", function(d) { return z(d.grpName); })
        .merge(lines)
          .attr('x1', function(d) { return x1(d.grpName)-5; })
          .attr('x2', function(d) { return x1(d.grpName)+5; })
          .attr('y1', function(d) { return y(d.y - d.e); })
          .attr('y2', function(d) { return y(d.y - d.e); });

        error_bar.selectAll('line.error')
          .attr("transform",function(d) { return "translate(" + x0(d.pgs) + ",0)"; });
      }

      /*var h_line = g.append('line')
                    .attr('class', 'line')
                    .style("stroke", ("3, 3"))
                    .attr("x1", 0)     // x position of the first end of the line
                    .attr("y1", 50)      // y position of the first end of the line
                    .attr("x2", 50)     // x position of the second end of the line
                    .attr("y2", 50);
      g.selectAll('line')
          .attr("transform",function(d) { return "translate(" + 0 + ",0)"; });*/

      // axes
      var xAxis = g.append('g')
        .attr('transform', 'translate(0,' + chartHeight + ')')
        .call( d3.axisBottom(x0) );
      var yAxis = g.append('g')
        .call( d3.axisLeft(y) );

      // Load data to the chart
      addData();



      var legend = g.append("g")
          .attr("font-family", "sans-serif")
          .attr("font-size", 10)
          .attr("text-anchor", "end")
          .selectAll("g")
          .data(groupNames.slice())
          .enter().append("g")
          .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

      legend.append("circle.point")
          .attr("x", width - 100)
          .attr("width", 15)
          .attr("height", 15)
          .attr("fill", z)
          .attr("stroke", z)
          .attr("stroke-width",2);

      legend.append("text")
          .attr("x", width - 50)
          .attr("y", 9.5)
          .attr("dy", "0.32em")
          .text(function(d) { return d; });

      // resize
      /*window.onresize = function() {
        width = document.documentElement.clientWidth;
        height = document.documentElement.clientHeight;

        var margin = {top: 20, right: 20, bottom: 30, left: 50};

        svg.attr('width', width).attr('height', height)


        chartWidth = width - margin.left - margin.right;
        chartHeight = height - margin.top - margin.bottom;

        //x.range([0, chartWidth]);
        //y.range([chartHeight, 0]);

        xAxis
          .attr('transform', 'translate(0,' + chartHeight + ')')
          .call( d3.axisBottom(x0) );
        yAxis.call( d3.axisLeft(y) );

        addData();
      };*/

    </script>
  </body>
</html>
